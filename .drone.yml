---
kind: pipeline
type: docker
name: default

clone:
  depth: 150

steps:
  - name: pre-commit
    image: docker:27.4.1
    environment:
      # Environment variables necessary for rootless Docker
      XDG_RUNTIME_DIR: "/run/user/1001"
      DOCKER_HOST: "unix:///run/user/1001/docker.sock"
    volumes:
      # Mounting Docker socket of rootless docker user
      - name: dockersock
        path: /run/user/1001/docker.sock
    commands:
      - docker ps && echo "tampered with"
      - echo "DRONE_COMMIT_BRANCH ${DRONE_COMMIT_BRANCH}"
      - docker compose -p fsfe-website-pre-commit run --remove-orphans --build pre-commit "origin/${DRONE_COMMIT_BRANCH}"

  - name: deploy-master
    image: docker:27.4.1
    environment:
      # Environment variables necessary for rootless Docker
      XDG_RUNTIME_DIR: "/run/user/1001"
      DOCKER_HOST: "unix:///run/user/1001/docker.sock"
      # Target use ipv4 proxies for noddack and gahn, as ipv6 broken.
      TARGET: "www@proxy.noris.fsfeurope.org:fsfe.org/global/?10322,www@proxy.plutex.fsfeurope.org:fsfe.org/global/?10322"
      FSFE_WEBSITE_KEY_PRIVATE:
        from_secret: KEY_PRIVATE
      FSFE_WEBSITE_KEY_PASSWORD:
        from_secret: KEY_PASSWORD
      FSFE_WEBSITE_GIT_TOKEN:
        from_secret: BUILD_TOKEN
      PROJECT: fsfe-website-master
    volumes:
      # Mounting Docker socket of rootless docker user
      - name: dockersock
        path: /run/user/1001/docker.sock
    commands:
      - docker ps && echo "tampered with"
      - docker compose -p "$PROJECT" down
      # If we are in a cron job, then do a full rebuild
      # Ideally the cron would set the flag itself, but drone does not support that.
      - if [ "$DRONE_BUILD_EVENT" = "cron" ]; then EXTRA_FLAGS="--full"; fi
      - docker compose -p "$PROJECT" run --remove-orphans --build build --target "$TARGET" $EXTRA_FLAGS
    when:
      branch:
        - master
      event:
        exclude:
          - pull_request

  - name: deploy-test
    image: docker:27.4.1
    environment:
      # Environment variables necessary for rootless Docker
      XDG_RUNTIME_DIR: "/run/user/1001"
      DOCKER_HOST: "unix:///run/user/1001/docker.sock"
      # Target use ipv4 proxies for noddack and gahn, as ipv6 broken.
      TARGET: "www@proxy.noris.fsfeurope.org:test.fsfe.org/global/?10322,www@proxy.plutex.fsfeurope.org:test.fsfe.org/global/?10322"
      FSFE_WEBSITE_KEY_PRIVATE:
        from_secret: KEY_PRIVATE
      FSFE_WEBSITE_KEY_PASSWORD:
        from_secret: KEY_PASSWORD
      FSFE_WEBSITE_GIT_TOKEN:
        from_secret: BUILD_TOKEN
      PROJECT: fsfe-website-test
    volumes:
      # Mounting Docker socket of rootless docker user
      - name: dockersock
        path: /run/user/1001/docker.sock
    commands:
      - docker ps && echo "tampered with"
      - docker compose -p "$PROJECT" down
      # If we are in a cron job, then do a full rebuild
      # Ideally the cron would set the flag itself, but drone does not support that.
      - if [ "$DRONE_BUILD_EVENT" = "cron" ]; then EXTRA_FLAGS="--full"; fi
      - docker compose -p "$PROJECT" run --remove-orphans --build build --target "$TARGET" $EXTRA_FLAGS
    when:
      branch:
        - test
      event:
        exclude:
          - pull_request
trigger:
  branch:
    - master
    - test
  event:
    - cron
    - custom
    - pull_request
    - push

node:
  cont2: noris

volumes:
  # Define Docker socket of rootless docker user
  - name: dockersock
    host:
      path: /run/user/1001/docker.sock
---
kind: signature
hmac: d01ec3f92e3e0261685c7c803c16002e809134015692d0cafb3eb8110365082f
